<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic CRM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .table-row-hover:hover {
            background-color: #e2e8f0; /* slate-200 */
            cursor: pointer;
        }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .person-accordion details[open] summary { background-color: #f1f5f9; }
        .filter-btn-active { background-color: #1e3a8a; color: white; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-screen-2xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-slate-800">Strategic Command Centre</h1>
            <p class="text-slate-500">Live data from Firestore.</p>
        </header>

        <section id="analytics-dashboard" class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Performance Metrics</h2>
                <div id="time-filter-buttons" class="flex items-center gap-2">
                    <button data-period="7" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">7D</button>
                    <button data-period="30" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300 filter-btn-active">30D</button>
                    <button data-period="90" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">90D</button>
                    <button data-period="all" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">All</button>
                </div>
            </div>
            <div id="analytics-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>

        <main id="table-view" class="bg-white rounded-lg shadow-sm border border-slate-200">
             <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                 <div id="table-filter-buttons" class="flex-shrink-0 flex items-center gap-2">
                     <button data-filter="all" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-blue-700 text-white">All</button>
                     <button data-filter="attention" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Needs Attention</button>
                     <button data-filter="talking" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Talking</button>
                     <button data-filter="client" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Clients</button>
                 </div>
                 <div class="flex items-center gap-4 w-full sm:w-auto">
                     <input type="text" id="search-input" placeholder="Search companies..." class="w-full sm:w-64 px-3 py-1.5 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                     <button id="add-company-btn" class="bg-blue-600 text-white font-semibold py-1.5 px-4 rounded-md hover:bg-blue-700 transition-colors whitespace-nowrap">+ Add Company</button>
                 </div>
             </div>
             <div class="overflow-x-auto">
                 <table class="w-full text-sm text-left text-slate-600">
                     <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                         <tr>
                             <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="name">Company</th>
                             <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="tier">Tier</th>
                             <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="stage">Overall Stage</th>
                             <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="attentionNeeded">Attention</th>
                             <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="lastContact">Last Contact</th>
                         </tr>
                     </thead>
                     <tbody id="companies-table-body"></tbody>
                 </table>
             </div>
        </main>
    </div>

    <div id="company-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95">
             <div class="flex justify-between items-center p-6 border-b">
                 <h2 id="modal-title" class="text-2xl font-bold text-slate-800">Company Details</h2>
                 <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
             </div>
             <div class="overflow-y-auto p-6" id="modal-body"></div>
             <div class="p-6 border-t bg-slate-50 flex justify-between items-center">
                 <button type="button" id="delete-company-btn" class="text-red-600 hover:text-red-800 font-semibold">Delete Company</button>
                 <button type="button" id="save-company-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save Changes</button>
             </div>
        </div>
    </div>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, setDoc, addDoc, deleteDoc, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CTO NOTE: SECURITY REMINDER
        // Your API keys are visible here. This is okay for an internal tool, but
        // be sure not to commit this file to a public repository like GitHub.
        const firebaseConfig = {
            apiKey: "AIzaSyBmLIojavz7ffqu3pdrIyZoer6dJ7HNg-c",
            authDomain: "mindmap-scc.firebaseapp.com",
            projectId: "mindmap-scc",
            storageBucket: "mindmap-scc.firebasestorage.app",
            messagingSenderId: "449001010150",
            appId: "1:449001010150:web:f20c8372ebdb55d3e25c27",
            measurementId: "G-6VS81GXRJV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let companies = [];
        let people = [];
        let sortState = { key: 'name', asc: true };
        let activeTableFilter = 'all';

        // --- DOM ELEMENT REFERENCES ---
        const tableBody = document.getElementById('companies-table-body');
        const searchInput = document.getElementById('search-input');
        const modal = document.getElementById('company-modal');
        const modalContent = document.getElementById('modal-content');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addCompanyBtn = document.getElementById('add-company-btn');
        const saveCompanyBtn = document.getElementById('save-company-btn');
        const deleteCompanyBtn = document.getElementById('delete-company-btn');

        // --- REAL-TIME DATA LOADING ---
        onSnapshot(collection(db, "companies"), (snapshot) => {
            companies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });

        onSnapshot(collection(db, "people"), (snapshot) => {
            people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
        });
        
        // --- CORE RENDER FUNCTIONS ---
        function renderAll() {
            renderTable();
        }

        function renderTable() {
            tableBody.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const augmentedCompanies = companies.map(augmentCompanyData);
            
            const filteredCompanies = augmentedCompanies
                .filter(c => c.name && c.name.toLowerCase().includes(searchTerm))
                // You can add your filter logic here later
                ;

            if (filteredCompanies.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">No companies found.</td></tr>`;
                return;
            }

            filteredCompanies.forEach(company => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b table-row-hover';
                row.dataset.id = company.id;
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900">${company.name || 'Unnamed Company'}</td>
                    <td class="px-6 py-4 text-center">${company.tier || 'N/A'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStageBadgeColor(company.stage)}">${company.stage}</span></td>
                    <td class="px-6 py-4 text-center">${company.attentionNeeded ? '<span class="text-amber-500 font-bold">●</span>' : '<span class="text-slate-300">-</span>'}</td>
                    <td class="px-6 py-4">${company.lastContact || 'N/A'}</td>
                `;
                row.addEventListener('click', () => openModal(company.id));
                tableBody.appendChild(row);
            });
        }
        
        // --- DATA LOGIC & UTILITIES ---

        // CTO NOTE: I have restored this logic. It calculates a company's status based on its people.
        // Feel free to adjust the rules here to match your business needs.
        function augmentCompanyData(company) {
            const companyPeople = people.filter(p => p.companyId === company.id);
            if (companyPeople.length === 0) {
                return { ...company, stage: 'To Research', attentionNeeded: true, lastContact: 'N/A' };
            }

            let allLogs = companyPeople.flatMap(p => (p.log || []).map(l => ({...l, personName: p.name})));
            allLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

            const lastContact = allLogs.length > 0 ? new Date(allLogs[0].date).toLocaleDateString('en-GB') : 'N/A';
            const daysSinceLastContact = allLogs.length > 0 ? (new Date() - new Date(allLogs[0].date)) / (1000 * 3600 * 24) : Infinity;
            
            // Determine overall stage (simple logic, can be improved)
            const stages = companyPeople.map(p => p.stage);
            let stage = 'To Contact';
            if (stages.includes('Client')) stage = 'Client';
            else if (stages.includes('In Conversation')) stage = 'In Conversation';
            else if (stages.includes('Contacted')) stage = 'Contacted';

            // Determine if attention is needed
            let attentionNeeded = false;
            if (stage === 'In Conversation' && daysSinceLastContact > 7) attentionNeeded = true;
            if (stage === 'Contacted' && daysSinceLastContact > 14) attentionNeeded = true;
            if (stage === 'To Contact') attentionNeeded = true;

            return { ...company, stage, attentionNeeded, lastContact };
        }

        function getStageBadgeColor(stage) {
            const stageColors = {
                'Client': 'bg-green-100 text-green-800',
                'In Conversation': 'bg-blue-100 text-blue-800',
                'Contacted': 'bg-indigo-100 text-indigo-800',
                'To Contact': 'bg-amber-100 text-amber-800',
                'To Research': 'bg-slate-200 text-slate-800',
                'Rejected': 'bg-red-100 text-red-800'
            };
            return stageColors[stage] || 'bg-slate-100 text-slate-800';
        }

        // --- MODAL & FORM HANDLING ---
        function openModal(companyId) {
            const company = companyId ? companies.find(c => c.id === companyId) : {};
            
            modalBody.innerHTML = `
                <form id="company-form">
                    <input type="hidden" id="company-id" value="${companyId || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label>Company</label><input type="text" id="company-name" value="${company.name || ''}" class="mt-1 block w-full rounded-md border-slate-300"></div>
                        <div><label>Tier</label><select id="tier" class="mt-1 block w-full rounded-md border-slate-300">${[1,2,3].map(t => `<option value="${t}" ${t === (company.tier || 1) ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                        <div><label>Sector</label><input type="text" id="sector" value="${company.sector || ''}" class="mt-1 block w-full rounded-md border-slate-300"></div>
                    </div>
                    <div><label>Rationale</label><textarea id="rationale" rows="3" class="mt-1 block w-full rounded-md border-slate-300">${company.rationale || ''}</textarea></div>
                </form>
                <hr class="my-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">People</h3>
                    <button id="add-person-btn" class="text-sm bg-slate-200 text-slate-800 font-semibold py-1 px-3 rounded-md hover:bg-slate-300">+ Add Person</button>
                </div>
                <div id="people-list" class="space-y-2"></div>`;

            document.getElementById('modal-title').textContent = companyId ? `Edit: ${company.name}` : 'Add New Company';
            deleteCompanyBtn.style.display = companyId ? 'block' : 'none';
            
            // renderPeopleInModal(companyId); // This function will need to be created to show people
            
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- FIRESTORE CRUD OPERATIONS ---
        async function handleSaveChanges() {
            const companyId = document.getElementById('company-id').value;
            const formData = {
                name: document.getElementById('company-name').value,
                tier: parseInt(document.getElementById('tier').value),
                sector: document.getElementById('sector').value,
                rationale: document.getElementById('rationale').value,
            };
            
            if (!formData.name) {
                alert('Company name is required.');
                return;
            }

            try {
                if (companyId) {
                    await setDoc(doc(db, "companies", companyId), formData, { merge: true });
                } else {
                    await addDoc(collection(db, "companies"), formData);
                }
                closeModal();
            } catch (e) {
                console.error("Error saving company: ", e);
                alert("Failed to save company.");
            }
        }

        async function handleDeleteCompany() {
            const companyId = document.getElementById('company-id').value;
            if (companyId && confirm('Are you sure you want to delete this company and all associated people?')) {
                try {
                    const peopleToDelete = people.filter(p => p.companyId === companyId);
                    const batch = writeBatch(db);
                    peopleToDelete.forEach(person => batch.delete(doc(db, "people", person.id)));
                    batch.delete(doc(db, "companies", companyId));
                    await batch.commit();
                    closeModal();
                } catch (e) {
                    console.error("Error deleting company: ", e);
                    alert("Failed to delete company.");
                }
            }
        }
        
        // --- EVENT LISTENERS ---
        addCompanyBtn.addEventListener('click', () => openModal(null));
        closeModalBtn.addEventListener('click', closeModal);
        saveCompanyBtn.addEventListener('click', handleSaveChanges);
        deleteCompanyBtn.addEventListener('click', handleDeleteCompany);
        searchInput.addEventListener('input', renderTable);

    </script>
</body>
</html>

