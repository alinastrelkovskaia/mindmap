<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic CRM Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for analytics visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FIREBASE SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      // We will import firestore functions in the main script
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .table-row-hover:hover {
            background-color: #e2e8f0; /* slate-200 */
            cursor: pointer;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .person-accordion details[open] summary {
            background-color: #f1f5f9; /* slate-100 */
        }
        .filter-btn-active {
            background-color: #1e3a8a; /* blue-800 */
            color: white;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-screen-2xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-slate-800">Strategic Command Centre</h1>
            <p class="text-slate-500">Live data from Firestore.</p>
        </header>

        <section id="analytics-dashboard" class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Performance Metrics</h2>
                <div id="time-filter-buttons" class="flex items-center gap-2">
                    <button data-period="7" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">7D</button>
                    <button data-period="30" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300 filter-btn-active">30D</button>
                    <button data-period="90" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">90D</button>
                    <button data-period="all" class="time-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">All</button>
                </div>
            </div>
            <div id="analytics-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>

        <main id="table-view" class="bg-white rounded-lg shadow-sm border border-slate-200">
             <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                 <div id="table-filter-buttons" class="flex-shrink-0 flex items-center gap-2">
                    <button data-filter="all" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-blue-700 text-white">All</button>
                    <button data-filter="attention" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Needs Attention</button>
                    <button data-filter="talking" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Talking</button>
                    <button data-filter="client" class="table-filter-btn px-3 py-1 text-sm font-semibold rounded-md bg-white border border-slate-300">Clients</button>
                </div>
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <input type="text" id="search-input" placeholder="Search companies..." class="w-full sm:w-64 px-3 py-1.5 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none">
                     <button id="add-company-btn" class="bg-blue-600 text-white font-semibold py-1.5 px-4 rounded-md hover:bg-blue-700 transition-colors whitespace-nowrap">+ Add Company</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="name">Company</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="tier">Tier</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="stage">Overall Stage</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="attentionNeeded">Attention</th>
                            <th scope="col" class="px-6 py-3 cursor-pointer" data-sort="lastContact">Last Contact</th>
                        </tr>
                    </thead>
                    <tbody id="companies-table-body"></tbody>
                </table>
            </div>
        </main>
    </div>

     <div id="company-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div id="modal-content" class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
             <div class="flex justify-between items-center p-6 border-b">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800">Company Details</h2>
                <button id="close-modal-btn" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
             </div>
             <div class="overflow-y-auto p-6" id="modal-body">
                <!-- Dynamically rendered -->
             </div>
             <div class="p-6 border-t bg-slate-50 flex justify-between items-center">
                <button type="button" id="delete-company-btn" class="text-red-600 hover:text-red-800 font-semibold">Delete Company</button>
                <button type="button" id="save-company-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save Changes</button>
             </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, getDoc, getDocs, 
            setDoc, addDoc, deleteDoc, query, where, writeBatch 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration from your project settings
        const firebaseConfig = {
          apiKey: "AIzaSyBmLIojavz7ffqu3pdrIyZoer6dJ7HNg-c",
          authDomain: "mindmap-scc.firebaseapp.com",
          projectId: "mindmap-scc",
          storageBucket: "mindmap-scc.appspot.com",
          messagingSenderId: "449001010150",
          appId: "1:449001010150:web:f20c8372ebdb55d3e25c27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const PERSON_STAGES = ['To Contact', 'Contacted', 'In Conversation', 'Client', 'Rejected'];
            let companies = [];
            let people = [];
            let sortState = { key: 'name', asc: true };
            let activeTableFilter = 'all';
            let activeTimePeriod = 30;

            const analyticsDashboard = document.getElementById('analytics-cards');
            const tableBody = document.getElementById('companies-table-body');
            const searchInput = document.getElementById('search-input');
            const modal = document.getElementById('company-modal');
            const modalContent = document.getElementById('modal-content');
            const modalBody = document.getElementById('modal-body');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addCompanyBtn = document.getElementById('add-company-btn');
            const saveCompanyBtn = document.getElementById('save-company-btn');
            const deleteCompanyBtn = document.getElementById('delete-company-btn');
            const timeFilterButtons = document.getElementById('time-filter-buttons');
            const tableFilterButtons = document.getElementById('table-filter-buttons');

            // --- REAL-TIME DATA LOADING ---
            const unsubCompanies = onSnapshot(collection(db, "companies"), (snapshot) => {
                companies = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                renderAll();
            });

            const unsubPeople = onSnapshot(collection(db, "people"), (snapshot) => {
                people = snapshot.docs.map(doc => ({ fbId: doc.id, ...doc.data() }));
                renderAll();
            });
            
            // --- RENDER FUNCTIONS (Largely the same as prototype) ---
            function renderAll() {
                renderTable();
                renderAnalytics();
            }

            function renderTable() {
                tableBody.innerHTML = '';
                const searchTerm = searchInput.value.toLowerCase();
                const augmentedCompanies = companies.map(augmentCompanyData);
                let filteredCompanies = augmentedCompanies
                    .filter(c => c.name.toLowerCase().includes(searchTerm))
                    .filter(c => {
                        if (activeTableFilter === 'all') return true;
                        if (activeTableFilter === 'attention') return c.attentionNeeded;
                        const stageKey = c.stage.toLowerCase().replace(/ /g, '');
                        if (activeTableFilter === 'clients') return stageKey === 'client';
                        return stageKey === activeTableFilter;
                    });
                
                filteredCompanies.sort((a, b) => { /* Sorting logic */ });

                if (filteredCompanies.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">No companies match your filters.</td></tr>`;
                    return;
                }

                filteredCompanies.forEach(company => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b table-row-hover';
                    row.dataset.id = company.id;
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-slate-900">${company.name}</td>
                        <td class="px-6 py-4 text-center">${company.tier}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStageBadgeColor(company.stage)}">${company.stage}</span></td>
                        <td class="px-6 py-4 text-center">${company.attentionNeeded ? '<span class="text-amber-500 font-bold">●</span>' : '<span class="text-slate-300">-</span>'}</td>
                        <td class="px-6 py-4">${company.lastContact || 'N/A'}</td>
                    `;
                    row.addEventListener('click', () => openModal(company.id));
                    tableBody.appendChild(row);
                });
            }
            
            function renderAnalytics() {
                // Same analytics logic as before
            }

            // --- UTILITY FUNCTIONS (Same as prototype) ---
            function augmentCompanyData(company) { /* ... */ }
            function getStageBadgeColor(stage) { /* ... */ }
            function getCompanyOverallStage(companyPeople, daysSinceLastContact, lastLogIsOutreach) { /* ... */ }
            
            // --- MODAL & DATA MODIFICATION ---
            function openModal(companyId) {
                const company = companies.find(c => c.id === companyId) || {};
                
                modalBody.innerHTML = `
                    <form id="company-form">
                        <input type="hidden" id="company-id" value="${companyId || ''}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label>Company</label><input type="text" id="company-name" value="${company.name || ''}" class="mt-1 block w-full rounded-md border-slate-300"></div>
                            <div><label>Tier</label><select id="tier" class="mt-1 block w-full rounded-md border-slate-300">${[1,2,3].map(t => `<option ${t === company.tier ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                            <div><label>Sector</label><input type="text" id="sector" value="${company.sector || ''}" class="mt-1 block w-full rounded-md border-slate-300"></div>
                        </div>
                        <div><label>Rationale</label><textarea id="rationale" rows="3" class="mt-1 block w-full rounded-md border-slate-300">${company.rationale || ''}</textarea></div>
                    </form>
                    <hr class="my-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-slate-800">People</h3>
                        <button id="add-person-btn" class="text-sm bg-slate-200 text-slate-800 font-semibold py-1 px-3 rounded-md hover:bg-slate-300">+ Add Person</button>
                    </div>
                    <div id="people-list" class="space-y-2"></div>`;

                document.getElementById('modal-title').textContent = companyId ? `Edit: ${company.name}` : 'Add New Company';
                deleteCompanyBtn.style.display = companyId ? 'block' : 'none';
                
                renderPeopleInModal(companyId);
                
                modal.classList.remove('hidden');
                setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); }, 10);
            }

            function closeModal() { /* ... */ }
            
            function renderPeopleInModal(companyId) {
                // Same logic as prototype
            }

            // --- FIRESTORE CRUD OPERATIONS ---
            async function handleSaveChanges() {
                const companyId = parseInt(document.getElementById('company-id').value);
                const formData = {
                    name: document.getElementById('company-name').value,
                    tier: parseInt(document.getElementById('tier').value),
                    sector: document.getElementById('sector').value,
                    rationale: document.getElementById('rationale').value,
                };
                
                try {
                    if (companyId) {
                        const companyDoc = companies.find(c => c.id === companyId);
                        const docRef = doc(db, "companies", companyDoc.fbId);
                        await setDoc(docRef, formData, { merge: true });
                    } else {
                        const newId = companies.length > 0 ? Math.max(...companies.map(c => c.id)) + 1 : 1;
                        await addDoc(collection(db, "companies"), { id: newId, ...formData });
                    }
                    closeModal();
                } catch (e) {
                    console.error("Error saving company: ", e);
                    alert("Failed to save company.");
                }
            }

            async function handleDeleteCompany() {
                const companyId = parseInt(document.getElementById('company-id').value);
                if (companyId && confirm('Are you sure you want to delete this company and all its people?')) {
                    try {
                        const companyDoc = companies.find(c => c.id === companyId);
                        const peopleToDelete = people.filter(p => p.companyId === companyId);
                        
                        const batch = writeBatch(db);
                        peopleToDelete.forEach(person => {
                            batch.delete(doc(db, "people", person.fbId));
                        });
                        batch.delete(doc(db, "companies", companyDoc.fbId));
                        
                        await batch.commit();
                        closeModal();
                    } catch (e) {
                        console.error("Error deleting company: ", e);
                        alert("Failed to delete company.");
                    }
                }
            }

            async function handleAddPerson(companyId) {
                const personName = prompt("Enter the new person's name:");
                if (personName && personName.trim()) {
                    const newPerson = {
                        companyId: companyId,
                        name: personName.trim(),
                        title: 'New Contact',
                        stage: 'To Contact',
                        log: []
                    };
                    try {
                        await addDoc(collection(db, "people"), newPerson);
                    } catch (e) {
                        console.error("Error adding person: ", e);
                        alert("Failed to add person.");
                    }
                }
            }
            
            async function handleUpdatePerson(personId, field, value) {
                const personDoc = people.find(p => p.id === personId);
                const docRef = doc(db, "people", personDoc.fbId);
                try {
                    await setDoc(docRef, { [field]: value }, { merge: true });
                } catch (e) {
                    console.error("Error updating person: ", e);
                }
            }
            
            async function handleAddLog(personId, logData) {
                const personDoc = people.find(p => p.id === personId);
                const newLog = [...personDoc.log, logData];
                const docRef = doc(db, "people", personDoc.fbId);
                try {
                    await setDoc(docRef, { log: newLog }, { merge: true });
                } catch (e) {
                    console.error("Error adding log: ", e);
                }
            }

            // --- EVENT LISTENERS ---
            addCompanyBtn.addEventListener('click', () => openModal(null));
            closeModalBtn.addEventListener('click', closeModal);
            saveCompanyBtn.addEventListener('click', handleSaveChanges);
            deleteCompanyBtn.addEventListener('click', handleDeleteCompany);

            modal.addEventListener('click', (e) => {
                if (e.target.id === 'add-person-btn') {
                    const companyId = parseInt(document.getElementById('company-id').value);
                    if (companyId) handleAddPerson(companyId);
                }
                if (e.target.classList.contains('add-person-log-btn')) {
                    // ... logic to get log data and call handleAddLog ...
                }
            });
            
             modal.addEventListener('change', (e) => {
                 if (e.target.classList.contains('person-edit-field')) {
                    const personId = parseInt(e.target.dataset.personId);
                    handleUpdatePerson(personId, e.target.dataset.field, e.target.value);
                }
            });

            // ... other filter and search event listeners ...
        });
    </script>
</body>
</html>
